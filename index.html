<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta Tags -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ToYou❤️ - Send your unsent messages</title>
  <meta property="og:title" content="ToYou❤️ - Send your unsent messages" />
  <meta property="og:description" content="Share your true feelings anonymously. Send a message to anyone, anytime. #ToYou❤️" />
  <meta property="og:image" content="https://impraveen07.github.io/ToYou-/f0.png" />
  <meta property="og:url" content="https://impraveen07.github.io/ToYou-/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ToYou❤️ - Send your unsent messages" />
  <meta name="twitter:description" content="Share your true feelings anonymously. Send a message to anyone, anytime. #ToYou❤️" />
  <meta name="twitter:image" content="https://impraveen07.github.io/ToYou-/f0.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
    :root {
      --theme-color-1: #A0E7E5;
      --theme-color-2: #FFD1DC;
      --theme-color-3: #FFF5BA;
    }
    body { background: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
    .header { font-family: 'Pacifico', cursive; font-size: 36px; position: fixed; top: 10px; left: 10px; z-index: 1001; color: #222; }
    .header span { color: red; }
    #menuIcon { position: fixed; top: 15px; right: 15px; width: 30px; height: 24px; cursor: pointer; z-index: 1002; }
    .bar { position: absolute; height: 4px; width: 100%; background-color: black; border-radius: 2px; left: 0; transition: transform 0.4s ease, opacity 0.4s ease; transform-origin: center; }
    .bar1 { top: 0; } .bar2 { top: 50%; transform: translateY(-50%); } .bar3 { bottom: 0; }
    #menuIcon.open .bar1 { transform: rotate(45deg); top: 50%; }
    #menuIcon.open .bar2 { opacity: 0; }
    #menuIcon.open .bar3 { transform: rotate(-45deg); top: 50%; bottom: auto; }
    #sidePanel { position: fixed; top: 0; right: -300px; height: 100vh; width: 250px; background: white; box-shadow: -2px 0 15px rgba(0,0,0,0.2); padding: 20px; border-radius: 10px 0 0 10px; transition: right 0.4s cubic-bezier(.4,0,.2,1); z-index: 1000; display: flex; flex-direction: column; align-items: center; opacity: 0; pointer-events: none; }
    #sidePanel.open { right: 0; opacity: 1; pointer-events: all; }
    #sidePanel h3 { margin-top: 20px; text-align: center; }
    #sidePanel ul { list-style: none; padding: 0; width: 100%; margin-top: 20px; }
    #sidePanel li { padding: 12px 0; text-align: center; border-bottom: 1px solid #ccc; font-weight: bold; transition: background-color 0.2s ease-in-out; cursor: pointer; }
    #sidePanel li:hover { background-color: #f1f1f1; }
    .image-container { margin-top: 80px; text-align: center; }
    .image-container img { width: 150px; height: auto; border-radius: 12px; }
    .search-bar { display: flex; justify-content: center; margin: 24px 0 12px 0; }
    .search-bar input { width: 260px; padding: 10px; font-size: 16px; border: 1.5px solid #ccc; border-radius: 8px 0 0 8px; outline: none; }
    .search-bar button { padding: 10px 18px; font-size: 16px; border: 1.5px solid #ccc; border-left: none; border-radius: 0 8px 8px 0; background: var(--theme-color-1); color: #222; cursor: pointer; font-weight: bold; transition: background 0.2s; }
    .search-bar button:hover { background: #7ed6d6; }
    #postCount { text-align:center; color:#555; font-size:16px; margin-bottom:10px; }
    .posts-list { max-width: 420px; margin: 0 auto 80px auto; padding: 0 10px; display: flex; flex-direction: column; gap: 0; }
    .post-wrapper { margin-bottom: 25px; }
    .nokia-post { background: var(--theme-color-1); width: 320px; min-height: 280px; border-radius: 25px; padding: 16px; box-shadow: 0 0 20px rgba(0,0,0,0.08); display: flex; flex-direction: column; justify-content: space-between; position: relative; color: black; font-family: 'Press Start 2P', monospace; margin: 0 auto; border: 2px solid transparent; }
    .nokia-post .top-bar { display: flex; justify-content: space-between; align-items: center; font-size: 10px; padding-bottom: 5px; }
    .nokia-post .time-display { min-width: 55px; }
    .nokia-post .receiver-name { flex: 1; text-align: center; font-weight: bold; font-size: 12px; }
    .nokia-post .right-icons { display: flex; align-items: center; gap: 6px; }
    .nokia-post .signal { display: flex; gap: 1px; flex-direction: row; transform: scaleY(-1); }
    .nokia-post .signal-bar { width: 3px; background: currentColor; }
    .nokia-post .signal-bar:nth-child(1) { height: 4px; } .nokia-post .signal-bar:nth-child(2) { height: 6px; } .nokia-post .signal-bar:nth-child(3) { height: 8px; } .nokia-post .signal-bar:nth-child(4) { height: 10px; }
    .nokia-post .battery-outline { width: 18px; height: 10px; border: 2px solid currentColor; display: flex; align-items: center; padding: 1px; position: relative; }
    .nokia-post .battery-fill { background: currentColor; height: 6px; width: 80%; }
    .nokia-post .battery-tip { width: 2px; height: 6px; background: currentColor; position: absolute; right: -4px; top: 1px; }
    .nokia-post .typing-area { flex-grow: 1; max-height: 180px; margin: 10px 0; position: relative; overflow-y: auto; font-size: 10px; line-height: 16px; padding-right: 5px; white-space: pre-wrap; word-break: break-word; scrollbar-width: thin; scrollbar-color: rgba(0,0,0,0.18) transparent; }
    .nokia-post .typing-area::-webkit-scrollbar { width: 6px; background: transparent; }
    .nokia-post .typing-area::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.18); border-radius: 4px; }
    .nokia-post .rainbow-text { font: 10px 'Press Start 2P', monospace; white-space: pre-wrap; line-height: 16px; word-break: break-word; }
    .nokia-post .meta-bar { font-size: 10px; display: flex; justify-content: space-between; margin-top: 8px; }
    .interaction-bar { display:flex; justify-content:center; gap:10px; margin-top:10px; }
    .interaction-bar button, .interaction-bar .views { font-size:10px; border:none; border-radius:8px; padding:5px 8px; cursor:pointer; align-self: center; }
    .interaction-bar button:disabled { cursor: not-allowed; opacity: 0.7; }
    .interaction-bar .like-btn { background: var(--theme-color-1); }
    .interaction-bar .dislike-btn { background: var(--theme-color-2); }
    .interaction-bar .report-btn { background: var(--theme-color-3); }
    .interaction-bar .views { color:#555; cursor: default;}
    .create-post-btn { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: var(--theme-color-1); color: #222; font-size: 18px; font-family: 'Pacifico', cursive; border: none; border-radius: 30px; padding: 14px 38px; box-shadow: 0 2px 8px rgba(0,0,0,0.13); cursor: pointer; z-index: 100; transition: background 0.2s; }
    .create-post-btn:hover { background: #7ed6d6; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.show { display: flex; }
    .screen { background: var(--theme-color-1); width: 320px; height: 300px; border-radius: 25px; padding: 16px; box-shadow: 0 0 20px rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: space-between; position: relative; color: black; font-family: 'Press Start 2P', monospace; }
    .menu-bar { font-size: 10px; display: flex; justify-content: space-between; }
    .menu-bar span { cursor: pointer; }
    #nokia-message { width: 100%; height: 100%; resize: none; background: transparent; border: none; font-size: 10px; font-family: 'Press Start 2P', monospace; color: black; outline: none; z-index: 10; position: absolute; line-height: 16px; overflow-y: auto; caret-color: black; padding-right: 5px; }
    .typing-area { height: 170px; margin: 10px 0; position: relative; overflow: hidden; }
    #rainbow-text-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; font: 10px 'Press Start 2P', monospace; white-space: pre-wrap; line-height: 16px; z-index: 5; pointer-events: none; word-break: break-word; }
    .theme-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; }
    .theme-box { background: white; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px; align-items: center; max-width: 90%; }
    .selected-preview { width: 40px; height: 40px; border: 3px solid black; background-size: cover; background-position: center; }
    .color-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .color-square { width: 30px; height: 30px; border: 2px solid black; cursor: pointer; }
    .image-theme-box { width: 70px; height: 70px; border: 2px solid #007A3D; border-radius: 10px; overflow: hidden; cursor: pointer; }
    .image-theme-box img { width: 100%; height: 100%; object-fit: cover; }
    .close-theme { font-size: 10px; cursor: pointer; }
    @media (max-width: 500px) { .screen, .nokia-post { width: 98vw; max-width: 340px; } .posts-list { max-width: 99vw; } }
    .contact-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 3001; opacity: 0; pointer-events: none; transition: opacity 0.35s cubic-bezier(.4,0,.2,1); }
    .contact-modal.show { opacity: 1; pointer-events: auto; }
    .form-box { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; position: relative; transform: scale(0.96) translateY(30px); opacity: 0; transition: transform 0.35s cubic-bezier(.4,0,.2,1), opacity 0.35s cubic-bezier(.4,0,.2,1); }
    .contact-modal.show .form-box { transform: scale(1) translateY(0); opacity: 1; }
    .form-box h2 { margin-bottom: 15px; font-size: 20px; text-align: center; }
    .close-btn { font-size: 16px; background: transparent; color: red; border: none; cursor: pointer; position: absolute; right: 10px; top: 10px; }
    .icon-img { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; border-radius: 6px; object-fit: cover; }
    .contact-links a { display: block; text-align: center; margin: 10px 0; font-size: 16px; color: #333; text-decoration: none; }
    .contact-links a:hover { text-decoration: underline; }
</style>
</head>
<body>
  <div class="header">ToYou<span>❤️</span></div>
  <div id="menuIcon"><div class="bar bar1"></div><div class="bar bar2"></div><div class="bar bar3"></div></div>
  <div id="sidePanel">
    <h3>Menu</h3>
    <ul>
        <li id="aboutUs">About Us</li>
        <li id="contactUs">Contact Us</li>
        <li id="help">Help</li>
        <li id="report">Report</li>
        <li id="improvement">Improvement</li>
    </ul>
  </div>
  <div class="image-container"><img src="f0.png" alt="ToYou Logo" /></div>
  <div class="search-bar"><input type="text" id="searchInput" placeholder="Search by receiver name..."><button id="searchBtn">Search</button></div>
  <div id="postCount"></div>
  <div class="posts-list" id="postsList"></div>
  <button class="create-post-btn" id="createPostBtn">+ Create Post</button>
  
  <div class="modal-overlay" id="composerModal">
    <div>
        <div class="screen" id="screen-box">
            <div class="top-bar">
                <span class="time-display" id="clock">--:--</span>
                <span class="receiver-name" id="receiver-name">To: Receiver</span>
                <div class="right-icons">
                    <div class="signal"><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div></div>
                    <div class="battery-outline"><div class="battery-fill"></div><div class="battery-tip"></div></div>
                </div>
            </div>
            <div class="typing-area">
                <div id="rainbow-text-overlay"></div>
                <textarea id="nokia-message" placeholder="Type your message..."></textarea>
            </div>
            <div class="menu-bar">
                <span id="cancelBtn">Cancel</span>
                <span id="themeBtn">Theme</span>
                <span id="saveBtn">Save</span>
            </div>
        </div>
        <div class="theme-popup" id="theme-popup">
            <div class="theme-box">
                <div>Selected:</div>
                <div class="selected-preview" id="selected-preview"></div>
                <div class="color-row">
                    <div class="color-square" style="background:#FFD1DC"></div><div class="color-square" style="background:#FFDFD3"></div><div class="color-square" style="background:#FFF5BA"></div><div class="color-square" style="background:#B5EAD7"></div><div class="color-square" style="background:#C3FBD8"></div>
                </div>
                <div class="color-row">
                    <div class="color-square" style="background:#A0E7E5"></div><div class="color-square" style="background:#D0F4DE"></div><div class="color-square" style="background:#FBCFE8"></div><div class="color-square" style="background:#FFC9DE"></div><div class="color-square" style="background:#E2F0CB"></div>
                </div>
                <div class="color-row">
                    <div class="image-theme-box" data-image="f1.jpg" data-textcolor="white"><img src="f1.jpg" alt="Theme"/></div>
                    <div class="image-theme-box" data-motivation="f2.jpg"><img src="f2.jpg" alt="Theme"/></div>
                    <div class="image-theme-box" data-image="f3.jpg" data-textcolor="white"><img src="f3.jpg" alt="Theme"/></div>
                </div>
                <div class="close-theme" id="closeThemeBtn">Close ⨉</div>
            </div>
        </div>
    </div>
  </div>
  <!-- About Us Modal -->
       <div class="contact-modal" id="aboutModal">
    <div class="form-box">
      <button class="close-btn" onclick="closeAbout()">✖</button>
      <h2>About Us</h2>
      <p style="font-size:15px;line-height:1.7;">
        <strong>ToYou❤️</strong> was created for everyone who wants to share their true feelings with someone special.<br><br>
        Life sometimes separates us from the people we care about, but words can still bring us closer. This website is a simple, safe space to send honest messages, confessions, or heartfelt notes—whether it’s to reconnect, say what’s on your mind, or just let someone know you care.<br><br>
        We believe that even a small message can make a big difference. If you have something to say, let <strong>ToYou❤️</strong> help you say it.<br><br>
        <span style="display: flex; align-items: center; margin-top: 16px;">
          <span>Developed by Praveen&nbsp;</span>
          <a href="https://www.instagram.com/pravee.n.n.n/?igsh=dmpidnM1OW9mcmdu" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: #333;">
            <img src="instagram.png" alt="Instagram" style="width: 22px; height: 22px; border-radius: 5px; object-fit: cover; margin-right: 5px;">
            @pravee.n.n.n
          </a>
        </span>
      </p>
    </div>
  </div>
    <!-- Contact Modal -->
  <div class="contact-modal" id="contactModal">
    <div class="form-box">
      <button class="close-btn" onclick="closeContact()">✖</button>
      <h2>Contact the Developer</h2>
      <div class="contact-links">
        <a href="mailto:zephyrax.co@gmail.com">
          <img src="gmail.png" alt="Gmail" class="icon-img" /> zephyrax.co@gmail.com
        </a>
        <a href="https://www.instagram.com/pravee.n.n.n/?igsh=dmpidnM1OW9mcmdu" target="_blank">
          <img src="instagram.png" alt="Instagram" class="icon-img" /> @pravee.n.n.n
        </a>
      </div>
    </div>
  </div>
  <div class="contact-modal" id="helpModal">
    <div class="form-box">
        <button class="close-btn" data-modal-id="helpModal">✖</button>
        <h2>Help</h2>
        <p style="font-size:15px;line-height:1.7;"><b>How to use:</b><br>1. Click <b>+ Create Post</b> to write.<br>2. Set a theme, message, and receiver's name.<br>3. Click <b>Save</b> to post anonymously.<br><br><b>Can I delete/edit?</b> Not yet. Contact us for removal.</p>
    </div>
  </div>
  <div class="contact-modal" id="reportModal">
    <div class="form-box">
        <button class="close-btn" data-modal-id="reportModal">✖</button>
        <h2>Report</h2>
        <p>Find an inappropriate post? Please take a screenshot and email it to <b>zephyrax.co@gmail.com</b> or DM <b>@pravee.n.n.n</b> on Instagram with the post details.</p>
    </div>
  </div>
  <div class="contact-modal" id="improvementModal">
    <div class="form-box">
        <button class="close-btn" data-modal-id="improvementModal">✖</button>
        <h2>Improvement</h2>
        <p>Have an idea to make ToYou❤️ better? We'd love to hear it! Email <b>zephyrax.co@gmail.com</b> or DM <b>@pravee.n.n.n</b> on Instagram.</p>
    </div>
  </div>

<script type="module">
// --- FIREBASE SETUP ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyBwEhCK0dpslmSHdL6OsAqJUM7ZUmtLqvU",
  authDomain: "toyou-a80b2.firebaseapp.com",
  projectId: "toyou-a80b2",
  storageBucket: "toyou-a80b2.appspot.com",
  messagingSenderId: "77162611167",
  appId: "1:77162611167:web:3dc6d01aa9dcd4bdc0046a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- DOM ELEMENTS & STATE ---
const postsList = document.getElementById('postsList');
const postCount = document.getElementById('postCount');
const searchInput = document.getElementById('searchInput');
const createPostBtn = document.getElementById('createPostBtn');
const composerModal = document.getElementById('composerModal');
const receiverNameEl = document.getElementById('receiver-name');
const nokiaMessage = document.getElementById('nokia-message');
const clock = document.getElementById('clock');
const rainbowOverlay = document.getElementById('rainbow-text-overlay');

let currentTheme = { type: "color", value: "#A0E7E5", textColor: "black" };
let isRainbowMode = false;
let allPosts = [];

// --- UTILITIES ---
function escapeHTML(str) {
    const p = document.createElement("p");
    p.textContent = str;
    return p.innerHTML;
}

function generateFakePosts() {
    const receivers = ["Luna", "Leo", "Mia", "Kai", "Zoe", "Alex", "Nora", "Praveen", "Rhea", "Sam", "My Love", "Bestie", "Crush"];
    const messages = ["I still think about our late night talks.", "Just wanted to say you're one of the kindest people I've ever met.", "Do you remember our silly inside jokes?", "I miss how simple things felt with you.", "Your laugh is contagious. Never lose that.", "Heard our favorite song and it made me think of you.", "Wishing you all the happiness in the world."];
    const senders = ["A friend", "Someone from the past", "An admirer", "Guess who?", "Anonymous"];
    const themes = [{ type: "color", value: "#FFD1DC", textColor: "black" }, { type: "color", value: "#B5EAD7", textColor: "black" }, { type: "color", value: "#A0E7E5", textColor: "black" }, { type: "image", value: "f1.jpg", textColor: "white" }];
    
    return Array.from({ length: 20 }, (_, i) => ({
        id: `fake_${i}`,
        receiver: receivers[Math.floor(Math.random() * receivers.length)],
        message: messages[Math.floor(Math.random() * messages.length)],
        sender: senders[Math.floor(Math.random() * senders.length)],
        theme: themes[Math.floor(Math.random() * themes.length)],
        rainbow: Math.random() > 0.85,
        created: new Date(Date.now() - i * 3600000 * 2).toISOString(),
        views: Math.floor(Math.random() * 250),
        likes: Math.floor(Math.random() * 60),
        dislikes: Math.floor(Math.random() * 5),
    }));
}

// --- CORE RENDERING FUNCTION ---
function renderPosts(postsToRender, searchTerm = "") {
  postsList.innerHTML = "";
  
  if (postsToRender.length === 0) {
    const safeTerm = escapeHTML(searchTerm);
    postCount.innerHTML = searchTerm ? `Posts for "<b>${safeTerm}</b>": 0` : "No posts yet. Be the first!";
    postsList.innerHTML = `<div style="text-align:center;color:#aaa;font-size:16px;margin-top:30px;">${searchTerm ? `No posts found for "<b>${safeTerm}</b>".` : 'Write a message to get started!'}</div>`;
    return;
  }
  
  postCount.innerHTML = searchTerm ? `Posts for "<b>${escapeHTML(searchTerm)}</b>": ${postsToRender.length}` : `Total posts: ${allPosts.length}`;

  for (const post of postsToRender) {
    const postWrapper = document.createElement('div');
    postWrapper.className = 'post-wrapper';
    
    const postDiv = document.createElement('div');
    postDiv.className = "nokia-post";
    postDiv.dataset.postId = post.id;

    const textColor = post.theme?.textColor || "black";
    postDiv.style.color = textColor;
    postDiv.style.borderColor = post.theme.type === 'color' ? post.theme.value : 'transparent';
    if (post.theme.type === "color") postDiv.style.backgroundColor = post.theme.value;
    else if (post.theme.type === "image") {
      postDiv.style.backgroundImage = `url('${post.theme.value}')`;
      postDiv.style.backgroundSize = 'cover';
      postDiv.style.backgroundPosition = 'center';
    }

    const time = new Date(post.created).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: true });
    const date = new Date(post.created).toLocaleDateString([], { dateStyle: "medium" });
    
    const msgHTML = post.rainbow
      ? `<div class="rainbow-text">${[...post.message].map((c, i) => `<span style="color:${['#FF6584', '#6CA0DC', '#E6D1F2', '#FFE066'][i % 4]}">${escapeHTML(c)}</span>`).join('')}</div>`
      : escapeHTML(post.message);
    
    postDiv.innerHTML = `
      <div class="top-bar"><span class="time-display">${time}</span><span class="receiver-name">${escapeHTML("To: " + post.receiver)}</span><div class="right-icons"><div class="signal"><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div></div><div class="battery-outline" style="border-color: ${textColor}"><div class="battery-fill" style="background: ${textColor}"></div><div class="battery-tip" style="background: ${textColor}"></div></div></div></div>
      <div class="typing-area">${msgHTML}</div>
      <div class="meta-bar"><span>${escapeHTML("By: " + (post.sender || "Anonymous"))}</span><span>${date}</span></div>
      <div style="text-align:center;font-size:12px;margin-top:6px;font-family:'Pacifico',cursive;">#ToYou❤️</div>
    `;

    const interactionBar = document.createElement('div');
    interactionBar.className = 'interaction-bar';

    const likeBtn = document.createElement('button');
    likeBtn.className = 'like-btn';
    likeBtn.dataset.count = post.likes || 0;
    likeBtn.innerHTML = `❤️ Like <span>(${post.likes || 0})</span>`;
    likeBtn.addEventListener('click', (e) => handleInteraction(e, post.id, 'like'));

    const dislikeBtn = document.createElement('button');
    dislikeBtn.className = 'dislike-btn';
    dislikeBtn.dataset.count = post.dislikes || 0;
    dislikeBtn.innerHTML = `💔 Dislike <span>(${post.dislikes || 0})</span>`;
    dislikeBtn.addEventListener('click', (e) => handleInteraction(e, post.id, 'dislike'));

    const reportBtn = document.createElement('button');
    reportBtn.className = 'report-btn';
    reportBtn.innerHTML = '⚠️ Report';
    reportBtn.addEventListener('click', () => reportPost(post.id, post.receiver));
    
    const viewsSpan = document.createElement('span');
    viewsSpan.className = 'views';
    viewsSpan.innerHTML = `👁 ${post.views || 0}`;

    interactionBar.append(likeBtn, dislikeBtn, reportBtn, viewsSpan);
    postWrapper.append(postDiv, interactionBar);
    postsList.appendChild(postWrapper);
    
    viewObserver.observe(postDiv);
  }
}

// --- DATA & VIEW LOGIC ---
const initialFakePosts = generateFakePosts();
onSnapshot(query(collection(db, "messages"), orderBy("created", "desc")), (snapshot) => {
  const firebasePosts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  allPosts = [...initialFakePosts, ...firebasePosts].sort((a, b) => new Date(b.created) - new Date(a.created));
  filterAndRender();
});

function filterAndRender() {
  const q = searchInput.value.trim().toLowerCase();
  const filtered = q ? allPosts.filter(p => p.receiver.toLowerCase().includes(q)) : allPosts;
  renderPosts(filtered, q);
}

// --- INTERACTION LOGIC (WITH SESSION & FAKE POST HANDLING) ---
const viewObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const postId = entry.target.dataset.postId;
            if (postId) {
                let viewedPosts = [];
                try {
                    viewedPosts = JSON.parse(sessionStorage.getItem('viewedPosts') || '[]');
                } catch (e) {
                    console.warn("Could not parse sessionStorage 'viewedPosts'");
                    sessionStorage.removeItem('viewedPosts');
                }

                if (!viewedPosts.includes(postId)) {
                    viewedPosts.push(postId);
                    try {
                        sessionStorage.setItem('viewedPosts', JSON.stringify(viewedPosts));
                    } catch(e) {
                        console.warn("Could not save to sessionStorage");
                    }
                    if (!postId.startsWith('fake_')) {
                        updateDoc(doc(db, "messages", postId), { views: increment(1) }).catch(console.error);
                    }
                }
                viewObserver.unobserve(entry.target);
            }
        }
    });
}, { threshold: 0.5 });

async function handleInteraction(event, id, type) {
    const btn = event.currentTarget;
    const countSpan = btn.querySelector('span');

    if (!countSpan) return;

    btn.disabled = true;

    if (id.startsWith('fake_')) {
        const currentCount = parseInt(btn.dataset.count || 0);
        const newCount = currentCount + 1;
        btn.dataset.count = newCount;
        countSpan.textContent = `(${newCount})`;
        return; // For fake posts, we only do the visual update and disable.
    }

    const field = type === 'like' ? 'likes' : 'dislikes';
    try {
        await updateDoc(doc(db, "messages", id), { [field]: increment(1) });
    } catch (err) {
        console.error(`${type} error:`, err);
        btn.disabled = false; // Re-enable only if there's an error
    }
    // No 'finally' block needed. Real-time listener will update the count and re-enable button on its own.
}

function reportPost(id, receiver) {
  if (id.startsWith('fake_')) { alert("This is a sample post and cannot be reported."); return; }
  const subject = encodeURIComponent("Report: ToYou❤️ Post");
  const body = encodeURIComponent(`I am reporting a post.\n\nPost ID: ${id}\nReceiver: ${receiver}\n\nReason:`);
  window.open(`mailto:zephyrax.co@gmail.com?subject=${subject}&body=${body}`);
  updateDoc(doc(db, "messages", id), { reports: increment(1) }).catch(()=>{});
}

// --- UI INITIALIZATION ---
function initApp() {
    updateClock();
    setInterval(updateClock, 30000);

    searchInput.addEventListener("input", filterAndRender);
    createPostBtn.addEventListener('click', () => composerModal.classList.add('show'));

    document.getElementById('menuIcon').addEventListener('click', (e) => {
        e.currentTarget.classList.toggle('open');
        document.getElementById('sidePanel').classList.toggle('open');
    });
    ['aboutUs','contactUs','help','report','improvement'].forEach(id => {
        document.getElementById(id).addEventListener('click', () => document.getElementById(id+'Modal').classList.add('show'));
    });
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => document.getElementById(e.currentTarget.dataset.modalId).classList.remove('show'));
    });

    document.getElementById('cancelBtn').addEventListener('click', () => composerModal.classList.remove('show'));
    document.getElementById('saveBtn').addEventListener('click', savePost);
    document.getElementById('themeBtn').addEventListener('click', () => document.getElementById("theme-popup").style.display = "flex");
    document.getElementById('closeThemeBtn').addEventListener('click', () => document.getElementById("theme-popup").style.display = "none");
    composerModal.addEventListener("mousedown", (e) => { if (e.target === composerModal) composerModal.classList.remove('show'); });
    receiverNameEl.addEventListener("click", () => {
        const name = prompt("Enter receiver's name:", receiverNameEl.textContent.replace(/^To:\s*/, ''));
        if (name && name.trim()) { receiverNameEl.textContent = "To: " + name.trim(); }
    });
    nokiaMessage.addEventListener('input', () => { if(isRainbowMode) rainbowHandler(); });
    
    document.querySelectorAll('.color-square').forEach(sq => sq.addEventListener('click', () => setTheme(sq.style.backgroundColor)));
    document.querySelectorAll('.image-theme-box').forEach(box => {
        box.addEventListener('click', () => {
            if (box.dataset.image) setImageTheme(box.dataset.image, box.dataset.textcolor);
            else if (box.dataset.motivation) setMotivationTheme();
        });
    });
}

async function savePost() {
  const receiver = receiverNameEl.textContent.replace(/^To:\s*/, "").trim();
  const message = nokiaMessage.value.trim();
  if (!receiver || receiver.toLowerCase() === 'receiver' || !message) {
    alert("Please enter a valid receiver's name and a message!");
    return;
  }
  let sender = prompt("Enter your name (optional, leave blank for Anonymous):", "");
  if (sender === null) return;
  const postData = { receiver, message, sender: sender.trim() || "Anonymous", theme: currentTheme, rainbow: isRainbowMode, created: new Date().toISOString(), views: 0, likes: 0, dislikes: 0, reports: 0 };
  
  const saveButton = document.getElementById('saveBtn');
  try {
    saveButton.textContent = 'Saving...';
    saveButton.style.pointerEvents = 'none';
    await addDoc(collection(db, "messages"), postData);
    composerModal.classList.remove('show');
    nokiaMessage.value = "";
    receiverNameEl.textContent = "To: Receiver";
  } catch (e) {
    alert("Error saving post: " + e.message);
  } finally {
    saveButton.textContent = 'Save';
    saveButton.style.pointerEvents = 'auto';
  }
}

// --- THEME FUNCTIONS ---
function updateClock() { clock.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
function setTheme(color) {
    const screenBox = document.getElementById("screen-box");
    screenBox.style.background = color; screenBox.style.color = 'black';
    nokiaMessage.style.color = "black"; nokiaMessage.style.caretColor = "black";
    rainbowOverlay.innerHTML = "";
    isRainbowMode = false;
    document.getElementById("selected-preview").style.background = color;
    currentTheme = { type: "color", value: color, textColor: "black" };
}
function setImageTheme(img, textColor) {
    const screenBox = document.getElementById("screen-box");
    const bg = `url(${img}) center/cover no-repeat`;
    screenBox.style.background = bg; screenBox.style.color = textColor;
    nokiaMessage.style.color = textColor; nokiaMessage.style.caretColor = textColor;
    rainbowOverlay.innerHTML = "";
    isRainbowMode = false;
    document.getElementById("selected-preview").style.background = bg;
    currentTheme = { type: "image", value: img, textColor };
}
function setMotivationTheme() {
    setImageTheme('f2.jpg', 'black');
    isRainbowMode = true;
    nokiaMessage.style.color = "transparent";
    rainbowHandler();
}
function rainbowHandler() {
    rainbowOverlay.innerHTML = [...nokiaMessage.value].map((c, i) => `<span style="color:${['#FF6584', '#6CA0DC', '#E6D1F2', '#FFE066'][i % 4]}">${escapeHTML(c)}</span>`).join('');
}

// Initialize the application once the DOM is ready
initApp();
  // Modal open/close with animation
function showModal(id) {
  document.getElementById(id).classList.add("show");
}
function hideModal(id) {
  document.getElementById(id).classList.remove("show");
}
document.getElementById('aboutUs').addEventListener('click', () => showModal('aboutModal'));
window.closeAbout = () => hideModal('aboutModal');
document.getElementById('contactUs').addEventListener('click', () => showModal('contactModal'));
window.closeContact = () => hideModal('contactModal');
document.getElementById('help').addEventListener('click', () => showModal('helpModal'));
window.closeHelp = () => hideModal('helpModal');
document.getElementById('report').addEventListener('click', () => showModal('reportModal'));
window.closeReport = () => hideModal('reportModal');
document.getElementById('improvement').addEventListener('click', () => showModal('improvementModal'));
window.closeImprovement = () => hideModal('improvementModal');

// Optional: Close modals when clicking outside
document.addEventListener('mousedown', function(e) {
  ['aboutModal','contactModal','helpModal','reportModal','improvementModal'].forEach(id=>{
    const modal = document.getElementById(id);
    if (modal.classList.contains('show') && !modal.querySelector('.form-box').contains(e.target) && !e.target.closest(`#${id}`)) {
      modal.classList.remove('show');
    }
  });
});
</script>
</body>
</html>
